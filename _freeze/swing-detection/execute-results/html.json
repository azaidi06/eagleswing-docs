{
  "hash": "18c38ad4daa198ea7f79b405c6d0f6b0",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Swing Detection\"\nsubtitle: \"Signal processing on wrist keypoints to find backswings and contacts\"\n---\n\n## Overview\n\nPure **numpy/scipy** — no OpenCV, no ML models. Takes a `.pkl` keypoint file and finds:\n\n1. **Backswing apex frames** — where the club reaches the top of the backswing\n2. **Contact/impact frames** — where the club hits the ball\n\nRuns on Lambda CPU in ~13 seconds.\n\n## Signal Pipeline\n\n```{mermaid}\nflowchart TD\n    PKL[\"Load .pkl<br/>(17 keypoints × N frames)\"] --> Extract[\"Extract wrist x,y<br/>(indices 9, 10)\"]\n    Extract --> Interp[\"Interpolate<br/>low-confidence gaps\"]\n    Interp --> Combine[\"Combine x + y<br/>into single signal\"]\n    Combine --> Smooth[\"Savitzky-Golay<br/>smoothing\"]\n    Smooth --> Peaks[\"scipy.find_peaks<br/>(prominence + distance)\"]\n    Peaks --> Filter[\"Filter chain<br/>(amplitude, spacing, edge)\"]\n    Filter --> Back[\"Backswing apex frames\"]\n    Back --> Contact[\"Search downswing<br/>for velocity minimum\"]\n    Contact --> Impact[\"Contact/impact frames\"]\n```\n\n## Config Parameters\n\nThe detection is controlled by a frozen dataclass with ~40 tunable parameters:\n\n::: {#9d6f5794 .cell execution_count=1}\n``` {.python .cell-code}\nfrom swing_detection.config import Config\n\ncfg = Config()\n# Key parameters:\n# cfg.savgol_window = 9       # Smoothing window\n# cfg.savgol_poly = 3         # Polynomial order\n# cfg.peak_prominence = 300   # Min peak height\n# cfg.peak_distance = 300     # Min frames between peaks\n# cfg.left_wrist = 9          # COCO-17 index\n# cfg.right_wrist = 10        # COCO-17 index\n```\n:::\n\n\n## Running Detection on a Sample\n\n::: {#fcaab8ff .cell execution_count=2}\n``` {.python .cell-code}\nimport pickle, pathlib, numpy as np\nimport matplotlib.pyplot as plt\nimport matplotlib\nmatplotlib.use(\"Agg\")\n\nroot = pathlib.Path(\"..\").resolve()\npkls = sorted(root.glob(\"test_trials/**/keypoints/*.pkl\"))\n\nif pkls:\n    pkl_path = pkls[0]\n\n    with open(pkl_path, \"rb\") as f:\n        data = pickle.load(f)\n\n    meta = data.get(\"__meta__\", {})\n    frame_keys = sorted([k for k in data if k != \"__meta__\"],\n                        key=lambda k: int(k.split(\"_\")[1]))\n\n    # Extract wrist coordinates\n    left_wrist_x = []\n    left_wrist_y = []\n    right_wrist_x = []\n    right_wrist_y = []\n\n    for k in frame_keys:\n        kp = np.array(data[k][\"keypoints\"])\n        left_wrist_x.append(kp[9, 0])\n        left_wrist_y.append(kp[9, 1])\n        right_wrist_x.append(kp[10, 0])\n        right_wrist_y.append(kp[10, 1])\n\n    lx = np.array(left_wrist_x)\n    ly = np.array(left_wrist_y)\n    rx = np.array(right_wrist_x)\n    ry = np.array(right_wrist_y)\n\n    fig, axes = plt.subplots(2, 1, figsize=(12, 6), sharex=True)\n\n    axes[0].plot(lx, alpha=0.3, label=\"L wrist x (raw)\")\n    axes[0].plot(rx, alpha=0.3, label=\"R wrist x (raw)\")\n    axes[0].set_ylabel(\"X position (pixels)\")\n    axes[0].legend()\n    axes[0].set_title(f\"Wrist Trajectories — {pkl_path.stem}\")\n\n    axes[1].plot(ly, alpha=0.3, label=\"L wrist y (raw)\")\n    axes[1].plot(ry, alpha=0.3, label=\"R wrist y (raw)\")\n    axes[1].set_ylabel(\"Y position (pixels)\")\n    axes[1].set_xlabel(\"Frame\")\n    axes[1].legend()\n\n    plt.tight_layout()\n    plt.show()\nelse:\n    print(\"No sample pkl files found\")\n```\n:::\n\n\n## Running the Actual Detector\n\n::: {#ac712ad7 .cell execution_count=3}\n``` {.python .cell-code}\nimport sys, pathlib\nroot = pathlib.Path(\"..\").resolve()\nsys.path.insert(0, str(root))\n\npkls = sorted(root.glob(\"test_trials/**/keypoints/*.pkl\"))\n\nif pkls:\n    from swing_detection import detect_backswings, detect_contacts\n\n    pkl_path = pkls[0]\n    print(f\"Detecting swings in: {pkl_path.name}\")\n\n    result = detect_backswings(str(pkl_path))\n    print(f\"\\nBackswing apex frames: {result.peak_frames}\")\n    print(f\"Total frames: {result.total_frames}\")\n    print(f\"FPS: {result.fps}\")\n    print(f\"Filter log:\")\n    for entry in result.filter_log:\n        print(f\"  {entry}\")\n\n    contact = detect_contacts(result)\n    print(f\"\\nContact frames: {contact.contact_frames}\")\n\n    # Plot smoothed signal with detections\n    import matplotlib.pyplot as plt\n    import matplotlib\n    matplotlib.use(\"Agg\")\n\n    fig, ax = plt.subplots(figsize=(12, 4))\n    ax.plot(result.smoothed, label=\"Smoothed wrist signal\", color=\"#3498db\")\n    for pf in result.peak_frames:\n        ax.axvline(pf, color=\"#e74c3c\", linestyle=\"--\", alpha=0.7, label=\"Backswing apex\")\n    for cf in contact.contact_frames:\n        if cf >= 0:\n            ax.axvline(cf, color=\"#2ecc71\", linestyle=\":\", alpha=0.7, label=\"Contact\")\n\n    # Deduplicate legend\n    handles, labels = ax.get_legend_handles_labels()\n    by_label = dict(zip(labels, handles))\n    ax.legend(by_label.values(), by_label.keys())\n    ax.set_xlabel(\"Frame\")\n    ax.set_ylabel(\"Combined wrist signal\")\n    ax.set_title(f\"Swing Detection — {pkl_path.stem}\")\n    plt.tight_layout()\n    plt.show()\nelse:\n    print(\"No sample pkl files found\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDetecting swings in: IMG_1016.pkl\n\nBackswing apex frames: [  950  1823  3941  6300  8165  9989 11524 13222 15094 16679 18469]\nTotal frames: 19750\nFPS: 59.94005994005994\nFilter log:\n  MAD: removed 1 peak(s) with x+y > 1148 (med=998, MAD=50)\n\nContact frames: [  975  1839  3957  6316  8181 10005 11540 13239 15110 16696 18486]\n```\n:::\n:::\n\n\n## Detection Data Structures\n\n::: {#e1a2eae4 .cell execution_count=4}\n``` {.python .cell-code}\nfrom dataclasses import dataclass\nimport numpy as np\n\n@dataclass\nclass DetectionResult:\n    name: str                    # Video name\n    peak_frames: np.ndarray      # Backswing apex frame indices\n    smoothed: np.ndarray         # Smoothed wrist signal (full length)\n    combined: np.ndarray         # Combined x,y signal before smoothing\n    fps: float                   # Video frame rate\n    total_frames: int            # Total frame count\n    filter_log: list             # Step-by-step filter trace\n    pkl_data: dict               # Full keypoint data (for downstream)\n\n@dataclass\nclass ContactResult:\n    name: str                    # Video name\n    contact_frames: np.ndarray   # Impact frames (-1 if not found for a swing)\n    backswing_result: DetectionResult\n    smoothed: np.ndarray         # Smoothed signal used for contact search\n```\n:::\n\n\n## Lambda Deployment\n\nThe detector runs as a Lambda triggered by S3 `.pkl` suffix events:\n\n::: {#53933692 .cell execution_count=5}\n``` {.python .cell-code}\n# lambda_handler.py — simplified flow\ndef handler(event, context):\n    bucket = event[\"Records\"][0][\"s3\"][\"bucket\"][\"name\"]\n    key = event[\"Records\"][0][\"s3\"][\"object\"][\"key\"]\n\n    # Download pkl from S3\n    pkl_path = download_from_s3(bucket, key)\n\n    # Run detection\n    result = detect_backswings(pkl_path)\n    contact = detect_contacts(result)\n\n    # Upload JSON to S3 /detection/\n    upload_json(bucket, key, result, contact)\n\n    # Write to DynamoDB\n    write_to_dynamo(result, contact)\n```\n:::\n\n\n",
    "supporting": [
      "swing-detection_files"
    ],
    "filters": [],
    "includes": {}
  }
}