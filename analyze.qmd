---
title: "Biomechanical Analysis"
subtitle: "Swing comparison, metrics, and statistical analysis"
---

## Overview

Takes keypoint pkl files + detection results and produces:

- **Swing-by-swing metric extraction** — shoulder turn, hip rotation, X-factor, spine angle, etc.
- **Statistical comparison** — SPM (Statistical Parametric Mapping) between swing groups
- **Medoid selection** — most representative swing from a set
- **Visualization** — overlay plots, metric time series, comparison grids

## Entry Points

```bash
# CLI pipeline (headless)
python -m analyze.pipeline --golfer stef --no-gemini --no-pushover

# With day filter and phase selection
python -m analyze.pipeline --golfer ymirza --day oct25 --phases backswing downswing

# Streamlit dashboard
streamlit run analyze/new_dashboard.py
```

## Core Data Structure

```{python}
#| eval: false
from dataclasses import dataclass
import numpy as np

@dataclass
class SwingData:
    name: str                       # Video/swing identifier
    keypoints: np.ndarray           # (phase_frames, 17, 2) — normalized
    keypoint_scores: np.ndarray     # (phase_frames, 17) — confidence
    fps: float                      # Frame rate
```

Swings are aligned by phase (backswing, downswing) and time-normalized for comparison.

## Metrics Computed

```{python}
#| echo: false
metrics = {
    "Rotation": ["Shoulder Turn", "Hip Turn", "X-Factor", "X-Factor Stretch"],
    "Posture": ["Spine Angle", "Shoulder Tilt", "Forward Bend"],
    "Linear": ["Hip Sway", "Head Height", "Weight Shift"],
}

for category, items in metrics.items():
    print(f"\n{category}:")
    for m in items:
        print(f"  - {m}")
```

Each metric is computed per-frame across a swing phase, producing time series that can be compared statistically.

## Analysis Pipeline Flow

```{mermaid}
flowchart TD
    CSV["CSV index<br/>(golfer, day, pkls)"] --> Load["Load pkl + detection<br/>per swing"]
    Load --> Phase["Phase extraction<br/>(backswing / downswing)"]
    Phase --> Norm["Time normalization<br/>(0-100% of phase)"]
    Norm --> Metrics["Metric computation<br/>(rotation, posture, linear)"]
    Metrics --> Medoid["Medoid selection<br/>(most representative swing)"]
    Metrics --> SPM["SPM t-test<br/>(group comparison)"]
    Medoid --> Plot["render_analysis_figure()"]
    SPM --> Plot
    Plot --> S3["Upload to S3 /analysis/"]
    Plot --> Push["Pushover notification"]
```

## Key Functions

```{python}
#| eval: false
# analyze/core.py

# Load and prepare swing data
load_golfer_data(csv_path, golfer, data_dir, back_frames, down_frames, day_filter)

# Build SwingData objects from dataframe
build_swing_items(df)  # → List[SwingData]

# Find most representative swing via directed Hausdorff distance
resolve_group_by_score(items, score_range)  # → filtered SwingData pool

# SPM comparison — per-metric t-tests across time-normalized phases
spm_compare(group_a, group_b, metrics)  # → significance maps
```

```{python}
#| eval: false
# analyze/plots.py

# Main rendering function
render_analysis_figure(
    src_items,        # Source swing group
    tgt_items,        # Target swing group
    phases,           # ["backswing", "downswing"]
    metrics,          # Which metrics to plot
    config            # PlotConfig (colors, sizes, etc.)
)  # → matplotlib Figure
```

## Streamlit Dashboard

`analyze/new_dashboard.py` provides an interactive UI for:

- Selecting golfer and day
- Choosing swing phases and metrics
- Comparing swing groups visually
- Viewing AI-generated analysis (via Gemini)

```bash
streamlit run analyze/new_dashboard.py
```
